---
# tasks file for digitransit-azure-deploy

- name: deploy digitransit-ui-hsl to DC/OS
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','digitransit-ui-hsl.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags: 
     - deploy

- name: deploy opentripplanner-hsl to DC/OS
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','opentripplanner-hsl.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags: 
     - deploy 

- name: deploy hsl-map-server to DC/OS
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','hsl-map-server.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags: 
     - deploy 

- name: deploy pelias-data-container to DC/OS
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','pelias-data-container.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
    tags: 
       - deploy

- name: deploy pelias-api to DC/OS
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','pelias-api.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags: 
     - deploy

- name: deploy siri2gtfsrt
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','siri2gtfsrt.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags:
     - deploy

- name: deploy raildigitraffic2gtfsrt.json
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','raildigitraffic2gtfsrt.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags:
     - deploy

- name: deploy digitransit site
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','digitransit-site.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags:
     - deploy

- name: deploy opentripplanner data container
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','opentripplanner-data-container.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags:
     - deploy


- name: deploy navigator server
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','navigator-server.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags:
     - deploy

- name: deploy digitransit-ui-matka
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','digitransit-ui-matka.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags:
     - deploy


- name: deploy hslalert
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','hslalert.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags:
     - deploy

- name: deploy opentripplanner waltti
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','opentripplanner-waltti.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags:
     - deploy




#digitransit proxy has to be the last component to be deployed
#LB DNS entries in DC/OS need to exist before NGINX container will start

- name: deploy digitransit proxy to DC/OS
  uri:
    url: "{{dcos_uri}}/apps"
    method: POST
    body: "{{ lookup('file','digitransit-proxy.json') }}"
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags: 
     - deploy




##This section of the role is for restarting already deployed applications 
##A restart usually desploys the lastest application from dockerhub

- name: restart service in marathon
  uri:
    url: "{{dcos_uri}}/apps/{{appid}}/restart"
    method: POST
    body: ""
    body_format: json
    HEADER_Content-Type: "application/json"
    status_code: 200,201
    ignore_errors: yes
  tags: 
     - restart


##This section of the role is for updating existing running apps 

